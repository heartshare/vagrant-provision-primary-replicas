- name: set up latest MaxScale repository
  yum_repository:
    name:        mariadb-maxscale
    description: MariaDB MaxScale
    baseurl:     https://downloads.mariadb.com/MaxScale/2.3/centos/$releasever/$basearch
    gpgkey:      https://downloads.mariadb.com/MaxScale/MariaDB-MaxScale-GPG-KEY
    gpgcheck:    1

- name: copy MaxScale configuration
  copy: src=maxscale.cnf dest=/etc/maxscale.cnf

- name: copy ~/.bash_history
  copy: src=bash_history dest=/root/.bash_history

- name: MaxScale {{ mxs_version }} rpm exists ?
  stat: path=/vagrant/maxscale-{{ mxs_version }}-1.rhel.7.x86_64.rpm
  register: maxscalerpm

- name: copy RPM and install
  shell: |
    cp /vagrant/maxscale-{{ mxs_version }}-*.rpm .
    yum -y localinstall maxscale-{{ mxs_version }}-*.rpm
  args:
    chdir: /root
  when: maxscalerpm.stat.exists

- name: install MaxScale from MariaDB repository
  yum:  name=maxscale state=latest
  when: not maxscalerpm.stat.exists

# - name: add maxscale group
#   group: name=maxscale state=present
#
# - name: add maxscale user
#   user: name=maxscale group=maxscale shell=/sbin/nologin

- name: enable/start MaxScale
  systemd: name=maxscale state=started enabled=True

- name: install lsyncd
  yum:  name=lsyncd state=latest

- name: copy lsyncd configuration
  template: src=lsyncd.conf dest=/etc/lsyncd.conf

- name: enable/start lsyncd
  systemd: name=lsyncd state=started enabled=True

- name: enable/start rsyncd
  systemd: name=rsyncd state=started enabled=True
